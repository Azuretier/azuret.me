<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RHYTHMIA NEXUS</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Zen+Kaku+Gothic+New:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --neon-pink: #FF6B9D;
            --neon-cyan: #4ECDC4;
            --neon-purple: #A29BFE;
            --dark-bg: #0a0a12;
            --darker-bg: #050508;
        }

        body {
            font-family: 'Zen Kaku Gothic New', sans-serif;
            background: var(--dark-bg);
            min-height: 100vh;
            overflow-x: hidden;
            color: #fff;
        }

        /* Animated background */
        .bg-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(78, 205, 196, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(78, 205, 196, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridMove 20s linear infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes gridMove {
            0% { transform: perspective(500px) rotateX(60deg) translateY(0); }
            100% { transform: perspective(500px) rotateX(60deg) translateY(50px); }
        }

        .bg-glow {
            position: fixed;
            width: 600px;
            height: 600px;
            border-radius: 50%;
            filter: blur(150px);
            opacity: 0.3;
            pointer-events: none;
            z-index: 0;
        }

        .glow-1 {
            top: -200px;
            left: -200px;
            background: var(--neon-pink);
            animation: glowPulse 8s ease-in-out infinite;
        }

        .glow-2 {
            bottom: -200px;
            right: -200px;
            background: var(--neon-cyan);
            animation: glowPulse 8s ease-in-out infinite 4s;
        }

        @keyframes glowPulse {
            0%, 100% { opacity: 0.2; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(1.2); }
        }

        /* Main container */
        .container {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            padding: 30px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: 'Orbitron', monospace;
            font-size: 1.8rem;
            font-weight: 900;
            letter-spacing: 0.3em;
            background: linear-gradient(135deg, var(--neon-pink), var(--neon-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(255, 107, 157, 0.5);
        }

        .status-bar {
            display: flex;
            gap: 20px;
            font-size: 0.85rem;
            opacity: 0.7;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ade80;
            animation: statusPulse 2s ease-in-out infinite;
        }

        @keyframes statusPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main content */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }

        .hero-text {
            text-align: center;
            margin-bottom: 60px;
        }

        .hero-text h1 {
            font-family: 'Orbitron', monospace;
            font-size: clamp(2rem, 8vw, 5rem);
            font-weight: 900;
            letter-spacing: 0.2em;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.7) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: titleGlow 3s ease-in-out infinite;
        }

        @keyframes titleGlow {
            0%, 100% { filter: drop-shadow(0 0 20px rgba(255,107,157,0.5)); }
            50% { filter: drop-shadow(0 0 40px rgba(78,205,196,0.8)); }
        }

        .hero-text p {
            font-size: 1.1rem;
            opacity: 0.6;
            letter-spacing: 0.3em;
            text-transform: uppercase;
        }

        /* Server selection */
        .server-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 30px;
            width: 100%;
            max-width: 900px;
        }

        .server-card {
            position: relative;
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 40px 30px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .server-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--card-color) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.4s;
        }

        .server-card:hover::before {
            opacity: 0.1;
        }

        .server-card:hover {
            transform: translateY(-10px) scale(1.02);
            border-color: var(--card-color);
            box-shadow: 
                0 20px 60px rgba(0,0,0,0.5),
                0 0 40px var(--card-color-dim);
        }

        .server-card.vanilla {
            --card-color: var(--neon-cyan);
            --card-color-dim: rgba(78, 205, 196, 0.3);
        }

        .server-card.modded {
            --card-color: var(--neon-pink);
            --card-color-dim: rgba(255, 107, 157, 0.3);
        }

        .card-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            display: block;
        }

        .card-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 6px 14px;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            border-radius: 20px;
            background: var(--card-color);
            color: var(--darker-bg);
        }

        .card-title {
            font-family: 'Orbitron', monospace;
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--card-color);
        }

        .card-subtitle {
            font-size: 0.9rem;
            opacity: 0.5;
            margin-bottom: 20px;
            letter-spacing: 0.2em;
            text-transform: uppercase;
        }

        .card-description {
            font-size: 0.95rem;
            line-height: 1.8;
            opacity: 0.7;
            margin-bottom: 25px;
        }

        .card-features {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
        }

        .feature-tag {
            padding: 6px 12px;
            font-size: 0.75rem;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            opacity: 0.8;
        }

        .card-stats {
            display: flex;
            gap: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-family: 'Orbitron', monospace;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--card-color);
        }

        .stat-label {
            font-size: 0.7rem;
            opacity: 0.5;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .play-button {
            position: relative;
            width: 100%;
            padding: 16px;
            margin-top: 20px;
            font-family: 'Orbitron', monospace;
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: var(--darker-bg);
            background: linear-gradient(135deg, var(--card-color), var(--card-color));
            border: none;
            border-radius: 12px;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.3s;
        }

        .play-button:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 30px var(--card-color-dim);
        }

        .play-button::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .play-button:hover::after {
            left: 100%;
        }

        /* Game iframe container */
        .game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--darker-bg);
            z-index: 100;
            display: none;
            flex-direction: column;
        }

        .game-container.active {
            display: flex;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: rgba(0,0,0,0.8);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .game-title {
            font-family: 'Orbitron', monospace;
            font-size: 1rem;
            letter-spacing: 0.2em;
        }

        .back-button {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            font-family: 'Orbitron', monospace;
            font-size: 0.85rem;
            letter-spacing: 0.1em;
            color: #fff;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .back-button:hover {
            background: rgba(255,255,255,0.2);
            border-color: var(--neon-cyan);
        }

        .game-frame {
            flex: 1;
            border: none;
            width: 100%;
        }

        /* Footer */
        footer {
            padding: 30px 40px;
            text-align: center;
            font-size: 0.8rem;
            opacity: 0.4;
            letter-spacing: 0.2em;
        }

        /* Responsive */
        @media (max-width: 768px) {
            header {
                padding: 20px;
                flex-direction: column;
                gap: 15px;
            }

            .server-grid {
                grid-template-columns: 1fr;
                padding: 0 10px;
            }

            .hero-text h1 {
                letter-spacing: 0.1em;
            }
        }

        /* Loading animation */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--darker-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            opacity: 1;
            transition: opacity 0.5s;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: var(--neon-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            font-family: 'Orbitron', monospace;
            font-size: 0.9rem;
            letter-spacing: 0.3em;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <!-- Background effects -->
    <div class="bg-grid"></div>
    <div class="bg-glow glow-1"></div>
    <div class="bg-glow glow-2"></div>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader"></div>
        <div class="loading-text">INITIALIZING...</div>
    </div>

    <div class="container">
        <header>
            <div class="logo">RHYTHMIA</div>
            <div class="status-bar">
                <div class="status-item">
                    <span class="status-dot"></span>
                    <span>„Çµ„Éº„Éê„ÉºÊé•Á∂ö‰∏≠</span>
                </div>
                <div class="status-item">
                    <span>v2.0.0</span>
                </div>
            </div>
        </header>

        <main>
            <div class="hero-text">
                <h1>SELECT SERVER</h1>
                <p>„Çµ„Éº„Éê„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Éó„É¨„Ç§ÈñãÂßã</p>
            </div>

            <div class="server-grid">
                <!-- Vanilla Server -->
                <div class="server-card vanilla" onclick="launchGame('vanilla')">
                    <span class="card-badge">OFFICIAL</span>
                    <span class="card-icon">üéÆ</span>
                    <h2 class="card-title">VANILLA</h2>
                    <p class="card-subtitle">Original Experience</p>
                    <p class="card-description">
                        „Ç™„É™„Ç∏„Éä„É´„ÅÆRHYTHMIA‰ΩìÈ®ì„ÄÇ„É™„Ç∫„É†„Å´‰πó„Å£„Å¶„Éñ„É≠„ÉÉ„ÇØ„ÇíÁ©ç„Åø„ÄÅ„ÉØ„Éº„É´„Éâ„ÇíÊîªÁï•„Åó„Çà„ÅÜ„ÄÇÁ¥îÁ≤ã„Å™„Ç≤„Éº„É†„Éó„É¨„Ç§„ÇíÊ•Ω„Åó„ÇÅ„Åæ„Åô„ÄÇ
                    </p>
                    <div class="card-features">
                        <span class="feature-tag">üéµ 5„ÉØ„Éº„É´„Éâ</span>
                        <span class="feature-tag">‚ö° „É™„Ç∫„É†„Ç∑„Çπ„ÉÜ„É†</span>
                        <span class="feature-tag">üé® „Ç™„É™„Ç∏„Éä„É´</span>
                    </div>
                    <div class="card-stats">
                        <div class="stat">
                            <div class="stat-value">100</div>
                            <div class="stat-label">BPM Start</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">160</div>
                            <div class="stat-label">BPM Max</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">‚àû</div>
                            <div class="stat-label">„É¨„Éô„É´</div>
                        </div>
                    </div>
                    <button class="play-button">‚ñ∂ PLAY NOW</button>
                </div>

                <!-- Modded Server -->
                <div class="server-card modded" onclick="launchGame('modded')">
                    <span class="card-badge">MODDED</span>
                    <span class="card-icon">‚ú®</span>
                    <h2 class="card-title">LIFE JOURNEY</h2>
                    <p class="card-subtitle">Zen Experience</p>
                    <p class="card-description">
                        ‰∫∫Áîü„ÅÆÊóÖ„Çí‰ΩìÈ®ì„Åô„Çã„Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Ç¢„Éº„Éà„ÄÇË™ïÁîü„Åã„ÇâÁ∂ôÊâø„Åæ„Åß„ÄÅ7„Å§„ÅÆÁ´†„ÇíÈÄö„Åò„Å¶‰∫∫Áîü„ÅÆÊÑèÂë≥„ÇíÊé¢Ê±Ç„Åó„Åæ„Åô„ÄÇ
                    </p>
                    <div class="card-features">
                        <span class="feature-tag">üåÖ 7„ÉÅ„É£„Éó„Çø„Éº</span>
                        <span class="feature-tag">üé® „Éì„Ç∏„É•„Ç¢„É´„Ç¢„Éº„Éà</span>
                        <span class="feature-tag">üìñ „Çπ„Éà„Éº„É™„Éº</span>
                    </div>
                    <div class="card-stats">
                        <div class="stat">
                            <div class="stat-value">7</div>
                            <div class="stat-label">Chapters</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">‚àû</div>
                            <div class="stat-label">„É™„Éó„É¨„Ç§</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">ZEN</div>
                            <div class="stat-label">Mode</div>
                        </div>
                    </div>
                    <button class="play-button">‚ñ∂ EXPERIENCE</button>
                </div>
            </div>
        </main>

        <footer>
            RHYTHMIA NEXUS ¬© 2025 ‚Äî PLAY YOUR RHYTHM
        </footer>
    </div>

    <!-- Game Container for Vanilla -->
    <div class="game-container" id="vanillaContainer">
        <div class="game-header">
            <span class="game-title">üéÆ RHYTHMIA ‚Äî VANILLA SERVER</span>
            <button class="back-button" onclick="closeGame('vanilla')">
                ‚Üê „É≠„Éì„Éº„Å´Êàª„Çã
            </button>
        </div>
        <iframe class="game-frame" id="vanillaFrame" srcdoc=""></iframe>
    </div>

    <!-- Game Container for Modded -->
    <div class="game-container" id="moddedContainer">
        <div class="game-header">
            <span class="game-title">‚ú® LIFE JOURNEY ‚Äî MOD SERVER</span>
            <button class="back-button" onclick="closeGame('modded')">
                ‚Üê „É≠„Éì„Éº„Å´Êàª„Çã
            </button>
        </div>
        <iframe class="game-frame" id="moddedFrame" srcdoc=""></iframe>
    </div>

    <script>
        // Loading animation
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }, 1500);
        });

        // Game content storage
        const gameContent = {
            vanilla: null,
            modded: null
        };

        // Vanilla game HTML (RHYTHMIA)
        gameContent.vanilla = `<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>RHYTHMIA</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-user-select: none; }
        
        html, body { 
            height: 100%; 
            overflow: hidden; 
            touch-action: manipulation;
            font-family: system-ui, -apple-system, sans-serif;
        }
        
        body {
            background: #0a0a12;
            transition: background 0.5s;
        }

        .w0 { --c1: #FF6B9D; --c2: #C44569; --bg: #1a1025; }
        .w1 { --c1: #4ECDC4; --c2: #1A535C; --bg: #051620; }
        .w2 { --c1: #FFE66D; --c2: #F7B731; --bg: #1a1505; }
        .w3 { --c1: #FF6B6B; --c2: #C0392B; --bg: #1a0a0a; }
        .w4 { --c1: #A29BFE; --c2: #6C5CE7; --bg: #0a0a1a; }

        body { background: var(--bg); }

        #game {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            gap: 10px;
        }

        #score-display {
            font-size: clamp(2rem, 8vw, 4rem);
            font-weight: 900;
            color: white;
            text-shadow: 0 0 30px var(--c1);
            transition: transform 0.1s;
        }
        #score-display.pop { transform: scale(1.2); }

        #combo {
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            font-weight: 700;
            color: var(--c1);
            opacity: 0;
            transform: scale(0);
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #combo.show { opacity: 1; transform: scale(1); }
        #combo.big { transform: scale(1.5); color: #FFD700; }

        #game-area {
            position: relative;
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        #board-wrap {
            position: relative;
            border: 3px solid var(--c1);
            border-radius: 8px;
            background: rgba(0,0,0,0.5);
            box-shadow: 0 0 30px var(--c1), inset 0 0 30px rgba(0,0,0,0.5);
            transition: box-shadow 0.1s, transform 0.1s;
            overflow: hidden;
        }
        #board-wrap.beat { 
            box-shadow: 0 0 50px var(--c1), 0 0 80px var(--c1), inset 0 0 30px rgba(0,0,0,0.5);
            transform: scale(1.02);
        }
        #board-wrap.shake {
            animation: shake 0.2s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        #board {
            display: grid;
            gap: 1px;
            position: relative;
        }

        .cell {
            width: clamp(16px, 4vw, 28px);
            height: clamp(16px, 4vw, 28px);
            background: rgba(255,255,255,0.03);
            border-radius: 2px;
            transition: all 0.1s;
        }
        .cell.filled {
            box-shadow: 0 0 10px currentColor, inset 0 0 8px rgba(255,255,255,0.3);
        }
        .cell.ghost {
            opacity: 0.3;
        }
        .cell.clearing {
            animation: clear 0.3s ease-out forwards;
        }
        @keyframes clear {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); background: white; }
            100% { transform: scale(0); opacity: 0; }
        }

        #active-piece {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            transition: transform 0.08s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 10;
        }
        #active-piece.dropping {
            transition: transform 0.02s linear;
        }
        .piece-cell {
            position: absolute;
            border-radius: 2px;
            box-shadow: 0 0 10px currentColor, inset 0 0 8px rgba(255,255,255,0.3);
        }

        #next-wrap {
            background: rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px;
        }
        #next-label {
            color: rgba(255,255,255,0.5);
            font-size: 0.7rem;
            text-align: center;
            margin-bottom: 5px;
        }
        #next {
            display: grid;
            gap: 1px;
        }
        .next-cell {
            width: clamp(12px, 3vw, 20px);
            height: clamp(12px, 3vw, 20px);
            border-radius: 2px;
        }

        #beat-bar {
            width: min(300px, 80vw);
            height: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        #beat-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--c2), var(--c1));
            border-radius: 10px;
            transition: width 0.05s linear;
            box-shadow: 0 0 20px var(--c1);
        }
        #beat-target {
            position: absolute;
            right: 10%;
            top: 0;
            bottom: 0;
            width: 15%;
            background: rgba(255,215,0,0.3);
            border: 2px solid #FFD700;
            border-radius: 8px;
        }

        #judgment {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: clamp(2rem, 10vw, 5rem);
            font-weight: 900;
            pointer-events: none;
            opacity: 0;
            z-index: 100;
        }
        #judgment.show {
            animation: judgePop 0.5s ease-out forwards;
        }
        @keyframes judgePop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            30% { opacity: 1; transform: translate(-50%, -50%) scale(1.3); }
            100% { opacity: 0; transform: translate(-50%, -60%) scale(1); }
        }

        #controls {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            width: min(350px, 90vw);
        }
        .ctrl-btn {
            aspect-ratio: 1;
            background: linear-gradient(135deg, var(--c1), var(--c2));
            border: none;
            border-radius: 12px;
            color: white;
            font-size: clamp(1.2rem, 4vw, 2rem);
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.1s, box-shadow 0.1s;
            -webkit-tap-highlight-color: transparent;
        }
        .ctrl-btn:active {
            transform: scale(0.9);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        #title-screen {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg);
            z-index: 200;
            gap: 30px;
        }
        #title-screen h1 {
            font-size: clamp(3rem, 12vw, 6rem);
            font-weight: 900;
            color: white;
            text-shadow: 0 0 30px var(--c1), 0 0 60px var(--c1);
        }
        #title-screen p {
            color: rgba(255,255,255,0.7);
            font-size: 1.2rem;
        }
        #start-btn {
            padding: 20px 60px;
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, var(--c1), var(--c2));
            border: none;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            box-shadow: 0 0 30px var(--c1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        #start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 50px var(--c1);
        }

        #world-display {
            position: fixed;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 0.9rem;
            opacity: 0.7;
        }

        #enemy-bar {
            width: min(250px, 70vw);
            height: 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            overflow: hidden;
        }
        #enemy-fill {
            height: 100%;
            background: linear-gradient(90deg, #FF4444, #FF8888);
            transition: width 0.3s;
            box-shadow: 0 0 10px #FF4444;
        }
        #enemy-label {
            color: rgba(255,255,255,0.6);
            font-size: 0.8rem;
            text-align: center;
        }

        #gameover {
            position: fixed;
            inset: 0;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.9);
            z-index: 200;
            gap: 20px;
        }
        #gameover.show { display: flex; }
        #gameover h2 {
            font-size: 3rem;
            color: var(--c1);
            text-shadow: 0 0 30px var(--c1);
        }
        #final-score {
            font-size: 2rem;
            color: white;
        }

        .particle {
            position: fixed;
            pointer-events: none;
            border-radius: 50%;
            z-index: 150;
        }

        #settings-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 50;
            transition: all 0.2s;
        }
        #settings-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: rotate(45deg);
        }

        #keybind-modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.9);
            z-index: 300;
        }
        #keybind-modal.show { display: flex; }
        
        #keybind-panel {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid var(--c1);
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 0 40px var(--c1);
        }
        #keybind-panel h2 {
            color: white;
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 0 10px var(--c1);
        }
        
        .keybind-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        .keybind-label {
            color: rgba(255,255,255,0.8);
            font-size: 0.95rem;
        }
        .keybind-key {
            min-width: 80px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .keybind-key:hover {
            border-color: var(--c1);
            box-shadow: 0 0 10px var(--c1);
        }
        .keybind-key.listening {
            border-color: #FFD700;
            box-shadow: 0 0 15px #FFD700;
            animation: pulse 0.5s infinite alternate;
        }
        @keyframes pulse {
            from { opacity: 0.7; }
            to { opacity: 1; }
        }
        
        .keybind-presets {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .preset-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, var(--c2), var(--c1));
            border: none;
            border-radius: 20px;
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .preset-btn:hover {
            transform: scale(1.05);
        }
        
        #keybind-close {
            display: block;
            width: 100%;
            margin-top: 20px;
            padding: 12px;
            background: linear-gradient(135deg, var(--c1), var(--c2));
            border: none;
            border-radius: 25px;
            color: white;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        #keybind-close:hover {
            transform: scale(1.02);
        }

        .keybind-hint {
            color: rgba(255,255,255,0.5);
            font-size: 0.75rem;
            text-align: center;
            margin-top: 12px;
        }
    </style>
</head>
<body class="w0">
    <div id="title-screen">
        <h1>RHYTHMIA</h1>
        <p>„É™„Ç∫„É†„Å´‰πó„Å£„Å¶„Éñ„É≠„ÉÉ„ÇØ„ÇíÁ©ç„ÇÅÔºÅ</p>
        <button id="start-btn">‚ñ∂ START</button>
    </div>

    <div id="game" style="display:none;">
        <div id="world-display">üéÄ „É°„É≠„Éá„Ç£„Ç¢</div>
        
        <div id="score-display">0</div>
        <div id="combo">10 COMBO!</div>
        
        <div id="enemy-label">üëª „Éé„Ç§„Ç∫„É™„É≥„Ç∞</div>
        <div id="enemy-bar"><div id="enemy-fill" style="width:100%"></div></div>
        
        <div id="game-area">
            <div id="board-wrap">
                <div id="board"></div>
                <div id="active-piece"></div>
            </div>
            <div id="next-wrap">
                <div id="next-label">NEXT</div>
                <div id="next"></div>
            </div>
        </div>
        
        <div id="beat-bar">
            <div id="beat-target"></div>
            <div id="beat-fill" style="width:0%"></div>
        </div>
        
        <div id="controls">
            <button class="ctrl-btn" data-action="rotate">‚Üª</button>
            <button class="ctrl-btn" data-action="left">‚Üê</button>
            <button class="ctrl-btn" data-action="down">‚Üì</button>
            <button class="ctrl-btn" data-action="right">‚Üí</button>
            <button class="ctrl-btn" data-action="drop">‚¨á</button>
        </div>
    </div>

    <div id="judgment"></div>

    <button id="settings-btn">‚öô</button>

    <div id="keybind-modal">
        <div id="keybind-panel">
            <h2>‚å®Ô∏è „Ç≠„Éº„Éê„Ç§„É≥„ÉâË®≠ÂÆö</h2>
            
            <div class="keybind-row">
                <span class="keybind-label">‚¨ÖÔ∏è Â∑¶ÁßªÂãï</span>
                <button class="keybind-key" data-action="left">‚Üê</button>
            </div>
            <div class="keybind-row">
                <span class="keybind-label">‚û°Ô∏è Âè≥ÁßªÂãï</span>
                <button class="keybind-key" data-action="right">‚Üí</button>
            </div>
            <div class="keybind-row">
                <span class="keybind-label">‚¨áÔ∏è ‰∏ãÁßªÂãï</span>
                <button class="keybind-key" data-action="down">‚Üì</button>
            </div>
            <div class="keybind-row">
                <span class="keybind-label">üîÑ ÂõûËª¢</span>
                <button class="keybind-key" data-action="rotate">‚Üë</button>
            </div>
            <div class="keybind-row">
                <span class="keybind-label">‚¨á „Éè„Éº„Éâ„Éâ„É≠„ÉÉ„Éó</span>
                <button class="keybind-key" data-action="drop">Space</button>
            </div>
            
            <div class="keybind-presets">
                <button class="preset-btn" data-preset="arrows">Áü¢Âç∞„Ç≠„Éº</button>
                <button class="preset-btn" data-preset="wasd">WASD</button>
                <button class="preset-btn" data-preset="vim">VimÈ¢® (HJKL)</button>
                <button class="preset-btn" data-preset="gamer">„Ç≤„Éº„Éû„Éº (ESDF)</button>
            </div>
            
            <p class="keybind-hint">„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åã„ÇâÂ•Ω„Åç„Å™„Ç≠„Éº„ÇíÊäº„Åó„Å¶Ë®≠ÂÆö</p>
            
            <button id="keybind-close">‚úî ÂÆå‰∫Ü</button>
        </div>
    </div>

    <div id="gameover">
        <h2>GAME OVER</h2>
        <div id="final-score">0</div>
        <button id="restart-btn" style="padding:15px 40px;font-size:1.2rem;background:linear-gradient(135deg,var(--c1),var(--c2));border:none;border-radius:30px;color:white;cursor:pointer;">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
    </div>

    <script>
        const W = 10, H = 18;
        const WORLDS = [
            { name: 'üéÄ „É°„É≠„Éá„Ç£„Ç¢', bpm: 100, colors: ['#FF6B9D','#FF8FAB','#FFB6C1','#C44569','#E8668B','#D4587D','#B84A6F'] },
            { name: 'üåä „Éè„Éº„É¢„Éã„Ç¢', bpm: 110, colors: ['#4ECDC4','#45B7AA','#3DA69B','#35958C','#2D847D','#26736E','#1A535C'] },
            { name: '‚òÄÔ∏è „ÇØ„É¨„Ç∑„Çß„É≥„ÉÄ', bpm: 120, colors: ['#FFE66D','#FFD93D','#F7B731','#ECA700','#D19600','#B68600','#9B7600'] },
            { name: 'üî• „Éï„Ç©„É´„ÉÜ„Ç£„ÉÉ„Ç∑„É¢', bpm: 140, colors: ['#FF6B6B','#FF5252','#FF3838','#FF1F1F','#E61717','#CC0F0F','#B30707'] },
            { name: '‚ú® ÈùôÂØÇ„ÅÆÈñì', bpm: 160, colors: ['#A29BFE','#9B8EFD','#9381FC','#8B74FB','#8367FA','#7B5AF9','#6C5CE7'] }
        ];
        
        const SHAPES = [
            [[1,1,1,1]],
            [[1,1],[1,1]],
            [[0,1,0],[1,1,1]],
            [[0,1,1],[1,1,0]],
            [[1,1,0],[0,1,1]],
            [[1,0,0],[1,1,1]],
            [[0,0,1],[1,1,1]]
        ];

        let board, piece, piecePos, nextPiece, score, combo, level, lines;
        let worldIdx, enemyHP, gameOver, paused;
        let beatPhase, lastBeat, audioCtx;
        let dropTimer, beatTimer;
        let cellSize = 20;
        let gapSize = 1;

        const $ = id => document.getElementById(id);
        const boardEl = $('board');
        const nextEl = $('next');
        const scoreEl = $('score-display');
        const comboEl = $('combo');
        const judgmentEl = $('judgment');
        const beatFill = $('beat-fill');
        const enemyFill = $('enemy-fill');
        const enemyLabel = $('enemy-label');
        const worldDisplay = $('world-display');
        const boardWrap = $('board-wrap');
        const activePieceEl = $('active-piece');

        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playTone(freq, dur = 0.1, type = 'sine') {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + dur);
        }

        function playDrum() {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        function playLineClear(count) {
            const freqs = [523, 659, 784, 1047];
            freqs.slice(0, count).forEach((f, i) => setTimeout(() => playTone(f, 0.15, 'triangle'), i * 60));
        }

        function spawnParticles(x, y, color, count = 8) {
            for (let i = 0; i < count; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                const size = Math.random() * 10 + 5;
                const angle = (Math.PI * 2 / count) * i;
                const dist = Math.random() * 80 + 40;
                p.style.cssText = \`
                    left: \${x}px; top: \${y}px;
                    width: \${size}px; height: \${size}px;
                    background: \${color};
                    box-shadow: 0 0 10px \${color};
                    transition: all 0.5s ease-out;
                \`;
                document.body.appendChild(p);
                requestAnimationFrame(() => {
                    p.style.transform = \`translate(\${Math.cos(angle) * dist}px, \${Math.sin(angle) * dist}px) scale(0)\`;
                    p.style.opacity = '0';
                });
                setTimeout(() => p.remove(), 500);
            }
        }

        function createBoard() {
            boardEl.innerHTML = '';
            boardEl.style.gridTemplateColumns = \`repeat(\${W}, 1fr)\`;
            for (let i = 0; i < W * H; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                boardEl.appendChild(cell);
            }
            
            requestAnimationFrame(() => {
                const firstCell = boardEl.querySelector('.cell');
                if (firstCell) {
                    const rect = firstCell.getBoundingClientRect();
                    cellSize = rect.width;
                }
            });
        }

        function randomPiece() {
            const world = WORLDS[worldIdx];
            const shape = SHAPES[Math.floor(Math.random() * SHAPES.length)];
            const color = world.colors[Math.floor(Math.random() * world.colors.length)];
            return { shape, color };
        }

        function drawBoard() {
            const cells = boardEl.children;
            const display = board.map(r => [...r]);
            
            if (piece) {
                let gy = piecePos.y;
                while (!collision(piece, piecePos.x, gy + 1)) gy++;
                piece.shape.forEach((row, py) => {
                    row.forEach((val, px) => {
                        if (val) {
                            const by = gy + py, bx = piecePos.x + px;
                            if (by >= 0 && by < H && bx >= 0 && bx < W && !display[by][bx]) {
                                display[by][bx] = { color: piece.color, ghost: true };
                            }
                        }
                    });
                });
            }
            
            for (let y = 0; y < H; y++) {
                for (let x = 0; x < W; x++) {
                    const cell = cells[y * W + x];
                    const val = display[y][x];
                    if (val) {
                        cell.className = 'cell filled' + (val.ghost ? ' ghost' : '');
                        cell.style.backgroundColor = val.color;
                        cell.style.color = val.color;
                    } else {
                        cell.className = 'cell';
                        cell.style.backgroundColor = '';
                        cell.style.color = '';
                    }
                }
            }
        }

        function drawActivePiece(instant = false) {
            if (!piece) {
                activePieceEl.innerHTML = '';
                return;
            }

            const firstCell = boardEl.querySelector('.cell');
            if (firstCell) {
                const rect = firstCell.getBoundingClientRect();
                cellSize = rect.width;
            }

            const unit = cellSize + gapSize;
            
            if (activePieceEl.children.length === 0 || activePieceEl.dataset.color !== piece.color) {
                activePieceEl.innerHTML = '';
                piece.shape.forEach((row, py) => {
                    row.forEach((val, px) => {
                        if (val) {
                            const cell = document.createElement('div');
                            cell.className = 'piece-cell';
                            cell.style.width = cellSize + 'px';
                            cell.style.height = cellSize + 'px';
                            cell.style.backgroundColor = piece.color;
                            cell.style.color = piece.color;
                            cell.style.left = (px * unit) + 'px';
                            cell.style.top = (py * unit) + 'px';
                            activePieceEl.appendChild(cell);
                        }
                    });
                });
                activePieceEl.dataset.color = piece.color;
            }

            if (instant) {
                activePieceEl.classList.add('dropping');
            } else {
                activePieceEl.classList.remove('dropping');
            }
            
            const x = piecePos.x * unit;
            const y = piecePos.y * unit;
            activePieceEl.style.transform = \`translate(\${x}px, \${y}px)\`;
        }

        function rebuildActivePiece() {
            activePieceEl.innerHTML = '';
            activePieceEl.dataset.color = '';
            drawActivePiece(true);
        }

        function drawNext() {
            if (!nextPiece) return;
            const shape = nextPiece.shape;
            nextEl.innerHTML = '';
            nextEl.style.gridTemplateColumns = \`repeat(\${shape[0].length}, 1fr)\`;
            shape.forEach(row => {
                row.forEach(val => {
                    const cell = document.createElement('div');
                    cell.className = 'next-cell';
                    if (val) {
                        cell.style.backgroundColor = nextPiece.color;
                        cell.style.boxShadow = \`0 0 8px \${nextPiece.color}\`;
                    }
                    nextEl.appendChild(cell);
                });
            });
        }

        function collision(p, x, y) {
            return p.shape.some((row, py) =>
                row.some((val, px) => {
                    if (!val) return false;
                    const nx = x + px, ny = y + py;
                    return nx < 0 || nx >= W || ny >= H || (ny >= 0 && board[ny][nx]);
                })
            );
        }

        function rotate(p) {
            return {
                ...p,
                shape: p.shape[0].map((_, i) => p.shape.map(row => row[i]).reverse())
            };
        }

        function lock() {
            const onBeat = beatPhase > 0.75 || beatPhase < 0.15;
            let mult = 1;
            
            if (onBeat) {
                mult = 2;
                combo++;
                showJudgment('PERFECT!', '#FFD700');
                playTone(1047, 0.2, 'triangle');
                const rect = boardWrap.getBoundingClientRect();
                spawnParticles(rect.left + rect.width/2, rect.top + rect.height/2, '#FFD700', 12);
            } else {
                combo = 0;
            }
            
            updateCombo();
            
            piece.shape.forEach((row, py) => {
                row.forEach((val, px) => {
                    if (val) {
                        const by = piecePos.y + py, bx = piecePos.x + px;
                        if (by >= 0 && by < H) {
                            board[by][bx] = { color: piece.color };
                        }
                    }
                });
            });
            
            let cleared = 0;
            const newBoard = [];
            const clearingRows = [];
            
            board.forEach((row, y) => {
                if (row.every(c => c !== null)) {
                    cleared++;
                    clearingRows.push(y);
                } else {
                    newBoard.push(row);
                }
            });
            
            if (cleared > 0) {
                const cells = boardEl.children;
                clearingRows.forEach(y => {
                    for (let x = 0; x < W; x++) {
                        cells[y * W + x].classList.add('clearing');
                    }
                });
                
                setTimeout(() => {
                    while (newBoard.length < H) newBoard.unshift(Array(W).fill(null));
                    board = newBoard;
                    
                    const pts = [0, 100, 300, 500, 800][cleared] * (level + 1) * mult * Math.max(1, combo);
                    score += pts;
                    lines += cleared;
                    
                    enemyHP = Math.max(0, enemyHP - cleared * 8 * mult);
                    enemyFill.style.width = enemyHP + '%';
                    
                    if (enemyHP <= 0) {
                        nextWorld();
                    }
                    
                    level = Math.floor(lines / 10);
                    updateScore();
                    playLineClear(cleared);
                    boardWrap.classList.add('shake');
                    setTimeout(() => boardWrap.classList.remove('shake'), 200);
                    
                    drawBoard();
                }, 300);
            }
            
            piece = nextPiece;
            nextPiece = randomPiece();
            piecePos = { x: Math.floor(W/2) - 1, y: 0 };
            rebuildActivePiece();
            drawNext();
            drawBoard();
            
            if (collision(piece, piecePos.x, piecePos.y)) {
                endGame();
            }
        }

        function move(dx, dy) {
            if (gameOver || paused || !piece) return;
            if (!collision(piece, piecePos.x + dx, piecePos.y + dy)) {
                piecePos.x += dx;
                piecePos.y += dy;
                if (dx !== 0) playTone(392, 0.05, 'square');
                drawActivePiece();
                drawBoard();
            } else if (dy > 0) {
                lock();
            }
        }

        function rotatePiece() {
            if (gameOver || paused || !piece) return;
            const rotated = rotate(piece);
            if (!collision(rotated, piecePos.x, piecePos.y)) {
                piece = rotated;
                playTone(523, 0.08);
                rebuildActivePiece();
                drawBoard();
            }
        }

        function hardDrop() {
            if (gameOver || paused || !piece) return;
            
            activePieceEl.classList.add('dropping');
            while (!collision(piece, piecePos.x, piecePos.y + 1)) {
                piecePos.y++;
            }
            playTone(196, 0.1, 'sawtooth');
            drawActivePiece(true);
            drawBoard();
            setTimeout(lock, 30);
        }

        function showJudgment(text, color) {
            judgmentEl.textContent = text;
            judgmentEl.style.color = color;
            judgmentEl.style.textShadow = \`0 0 30px \${color}\`;
            judgmentEl.className = '';
            void judgmentEl.offsetWidth;
            judgmentEl.classList.add('show');
        }

        function updateScore() {
            scoreEl.textContent = score.toLocaleString();
            scoreEl.classList.add('pop');
            setTimeout(() => scoreEl.classList.remove('pop'), 100);
        }

        function updateCombo() {
            if (combo >= 2) {
                comboEl.textContent = combo + ' COMBO!';
                comboEl.classList.add('show');
                if (combo >= 5) comboEl.classList.add('big');
                else comboEl.classList.remove('big');
            } else {
                comboEl.classList.remove('show', 'big');
            }
        }

        function nextWorld() {
            worldIdx++;
            if (worldIdx >= WORLDS.length) {
                showJudgment('üéâ CLEAR!', '#FFD700');
                setTimeout(() => {
                    worldIdx = 0;
                    enemyHP = 100;
                    setWorld();
                }, 2000);
            } else {
                showJudgment('WORLD CLEAR!', '#00FF00');
                enemyHP = 100;
                setWorld();
            }
        }

        function setWorld() {
            const world = WORLDS[worldIdx];
            document.body.className = 'w' + worldIdx;
            worldDisplay.textContent = world.name;
            enemyFill.style.width = enemyHP + '%';
            
            clearInterval(beatTimer);
            const interval = 60000 / world.bpm;
            lastBeat = Date.now();
            beatTimer = setInterval(() => {
                lastBeat = Date.now();
                boardWrap.classList.add('beat');
                playDrum();
                setTimeout(() => boardWrap.classList.remove('beat'), 100);
            }, interval);
        }

        function startGame() {
            board = Array(H).fill().map(() => Array(W).fill(null));
            score = 0;
            combo = 0;
            level = 0;
            lines = 0;
            worldIdx = 0;
            enemyHP = 100;
            gameOver = false;
            paused = false;
            
            piece = randomPiece();
            nextPiece = randomPiece();
            piecePos = { x: Math.floor(W/2) - 1, y: 0 };
            
            createBoard();
            
            requestAnimationFrame(() => {
                const firstCell = boardEl.querySelector('.cell');
                if (firstCell) {
                    const rect = firstCell.getBoundingClientRect();
                    cellSize = rect.width;
                }
                
                drawBoard();
                rebuildActivePiece();
                drawNext();
                updateScore();
                updateCombo();
                setWorld();
            });
            
            $('title-screen').style.display = 'none';
            $('game').style.display = 'flex';
            $('gameover').classList.remove('show');
            
            clearInterval(dropTimer);
            dropTimer = setInterval(() => {
                if (!gameOver && !paused) {
                    move(0, 1);
                }
            }, 500);
            
            requestAnimationFrame(function updateBeat() {
                if (!gameOver) {
                    const world = WORLDS[worldIdx];
                    const interval = 60000 / world.bpm;
                    const elapsed = Date.now() - lastBeat;
                    beatPhase = (elapsed % interval) / interval;
                    beatFill.style.width = (beatPhase * 100) + '%';
                    requestAnimationFrame(updateBeat);
                }
            });
        }

        function endGame() {
            gameOver = true;
            clearInterval(dropTimer);
            clearInterval(beatTimer);
            $('final-score').textContent = score.toLocaleString() + ' pts';
            $('gameover').classList.add('show');
            playTone(131, 0.5, 'sawtooth');
        }

        $('start-btn').onclick = () => {
            initAudio();
            startGame();
        };
        
        $('restart-btn').onclick = () => {
            startGame();
        };

        document.querySelectorAll('.ctrl-btn').forEach(btn => {
            const action = btn.dataset.action;
            let lastTrigger = 0;
            const handler = (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const now = Date.now();
                if (now - lastTrigger < 100) return;
                lastTrigger = now;
                
                switch(action) {
                    case 'left': move(-1, 0); break;
                    case 'right': move(1, 0); break;
                    case 'down': move(0, 1); break;
                    case 'rotate': rotatePiece(); break;
                    case 'drop': hardDrop(); break;
                }
            };
            
            btn.addEventListener('touchend', handler, { passive: false });
            btn.addEventListener('click', (e) => {
                if (e.sourceCapabilities && e.sourceCapabilities.firesTouchEvents) return;
                handler(e);
            });
        });

        const DEFAULT_KEYBINDS = {
            left: 'ArrowLeft',
            right: 'ArrowRight',
            down: 'ArrowDown',
            rotate: 'ArrowUp',
            drop: ' '
        };
        
        const PRESETS = {
            arrows: { left: 'ArrowLeft', right: 'ArrowRight', down: 'ArrowDown', rotate: 'ArrowUp', drop: ' ' },
            wasd: { left: 'a', right: 'd', down: 's', rotate: 'w', drop: ' ' },
            vim: { left: 'h', right: 'l', down: 'j', rotate: 'k', drop: ' ' },
            gamer: { left: 's', right: 'f', down: 'd', rotate: 'e', drop: ' ' }
        };
        
        let keybinds = { ...DEFAULT_KEYBINDS };
        let listeningFor = null;
        
        function loadKeybinds() {
            try {
                const saved = localStorage.getItem('rhythmia-keybinds');
                if (saved) {
                    keybinds = { ...DEFAULT_KEYBINDS, ...JSON.parse(saved) };
                }
            } catch (e) {
                console.log('„Ç≠„Éº„Éê„Ç§„É≥„ÉâË™≠„ÅøËæº„ÅøÂ§±Êïó');
            }
            updateKeybindDisplay();
        }
        
        function saveKeybinds() {
            try {
                localStorage.setItem('rhythmia-keybinds', JSON.stringify(keybinds));
            } catch (e) {
                console.log('„Ç≠„Éº„Éê„Ç§„É≥„Éâ‰øùÂ≠òÂ§±Êïó');
            }
        }
        
        function formatKeyName(key) {
            const keyNames = {
                ' ': 'Space',
                'ArrowLeft': '‚Üê',
                'ArrowRight': '‚Üí',
                'ArrowUp': '‚Üë',
                'ArrowDown': '‚Üì',
                'Enter': 'Enter',
                'Shift': 'Shift',
                'Control': 'Ctrl',
                'Alt': 'Alt',
                'Tab': 'Tab',
                'Escape': 'Esc',
                'Backspace': '‚å´'
            };
            return keyNames[key] || key.toUpperCase();
        }
        
        function updateKeybindDisplay() {
            document.querySelectorAll('.keybind-key').forEach(btn => {
                const action = btn.dataset.action;
                if (keybinds[action]) {
                    btn.textContent = formatKeyName(keybinds[action]);
                }
            });
        }
        
        const keybindModal = $('keybind-modal');
        const settingsBtn = $('settings-btn');
        
        settingsBtn.onclick = () => {
            keybindModal.classList.add('show');
            paused = true;
        };
        
        $('keybind-close').onclick = () => {
            keybindModal.classList.remove('show');
            listeningFor = null;
            document.querySelectorAll('.keybind-key').forEach(k => k.classList.remove('listening'));
            paused = false;
            saveKeybinds();
        };
        
        document.querySelectorAll('.keybind-key').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.keybind-key').forEach(k => k.classList.remove('listening'));
                btn.classList.add('listening');
                btn.textContent = '...';
                listeningFor = btn.dataset.action;
            };
        });
        
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.onclick = () => {
                const preset = PRESETS[btn.dataset.preset];
                if (preset) {
                    keybinds = { ...preset };
                    updateKeybindDisplay();
                    playTone(880, 0.1);
                }
            };
        });
        
        document.addEventListener('keydown', e => {
            if (listeningFor && keybindModal.classList.contains('show')) {
                e.preventDefault();
                
                if (e.key === 'Escape') {
                    document.querySelectorAll('.keybind-key').forEach(k => k.classList.remove('listening'));
                    listeningFor = null;
                    updateKeybindDisplay();
                    return;
                }
                
                keybinds[listeningFor] = e.key;
                updateKeybindDisplay();
                document.querySelectorAll('.keybind-key').forEach(k => k.classList.remove('listening'));
                listeningFor = null;
                playTone(523, 0.1);
                return;
            }
            
            if (keybindModal.classList.contains('show')) return;
            
            if (e.key === keybinds.left) move(-1, 0);
            else if (e.key === keybinds.right) move(1, 0);
            else if (e.key === keybinds.down) move(0, 1);
            else if (e.key === keybinds.rotate) rotatePiece();
            else if (e.key === keybinds.drop) { e.preventDefault(); hardDrop(); }
        });

        beatPhase = 0;
        lastBeat = Date.now();
        loadKeybinds();
    <\/script>
</body>
</html>`;

        // Modded game HTML (Life Journey)
        gameContent.modded = `<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFE JOURNEY</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"><\/script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"><\/script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"><\/script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { min-height: 100vh; }
        #root { min-height: 100vh; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState } = React;

        const chapters = [
          {
            id: 'birth',
            title: 'Ë™ïÁîü',
            subtitle: 'Genesis',
            color: '#FFE4E1',
            accent: '#FF6B6B',
            emoji: 'üåÖ',
            poem: 'ÂÖâ„ÅÆ‰∏≠„Å∏',
            description: 'ÁÑ°Èôê„ÅÆÂèØËÉΩÊÄß„ÇíÊä±„ÅÑ„Å¶„ÄÅ„Åì„ÅÆ‰∏ñÁïå„Å´Áîü„Åæ„ÇåËêΩ„Å°„ÇãÁû¨Èñì„ÄÇ„Åô„Åπ„Å¶„ÅåÊñ∞„Åó„Åè„ÄÅ„Åô„Åπ„Å¶„ÅåÁú©„Åó„ÅÑ„ÄÇ',
            visual: 'radial-gradient(ellipse at 50% 100%, #FFB6C1 0%, #FFE4E1 40%, #FFF8DC 100%)'
          },
          {
            id: 'growth',
            title: 'ÊàêÈï∑',
            subtitle: 'Bloom',
            color: '#E8F5E9',
            accent: '#4CAF50',
            emoji: 'üå±',
            poem: 'Ê†π„ÇíÂºµ„Çä„ÄÅÁ©∫„Å∏',
            description: 'Â∞è„Åï„Å™ËäΩ„ÅåÂúü„ÇíÁ†¥„Çä„ÄÅÂ§™ÈôΩ„Å´Âêë„Åã„Å£„Å¶‰º∏„Å≥„Å¶„ÅÑ„Åè„ÄÇÂ•ΩÂ•áÂøÉ„Å®Áô∫Ë¶ã„ÅÆÊó•„ÄÖ„ÄÇ',
            visual: 'linear-gradient(180deg, #87CEEB 0%, #E8F5E9 50%, #8B4513 100%)'
          },
          {
            id: 'adventure',
            title: 'ÂÜíÈô∫',
            subtitle: 'Journey',
            color: '#E3F2FD',
            accent: '#2196F3',
            emoji: '‚õµ',
            poem: 'Êú™Áü•„Å™„ÇãÊµ∑„Å∏',
            description: 'Â∫É„ÅÑ‰∏ñÁïå„Å´È£õ„Å≥Âá∫„Åó„ÄÅËá™ÂàÜ„Å†„Åë„ÅÆÈÅì„ÇíÂàá„ÇäÈñã„Åè„ÄÇÊåëÊà¶„Å®ÂãáÊ∞ó„ÅÆÂ≠£ÁØÄ„ÄÇ',
            visual: 'linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%)'
          },
          {
            id: 'love',
            title: 'ÊÑõ',
            subtitle: 'Love',
            color: '#FCE4EC',
            accent: '#E91E63',
            emoji: 'üíï',
            poem: '‰∫å„Å§„ÅÆÈ≠Ç„ÅåÂá∫‰ºö„ÅÜ',
            description: 'Ë™∞„Åã„Å®Ê∑±„ÅèÁπã„Åå„Çä„ÄÅÂøÉ„ÇíÈñã„ÅèÂñú„Å≥„Å®Áóõ„Åø„ÄÇ‰∫∫Áîü„ÇíÂΩ©„ÇãÊúÄ„ÇÇÁæé„Åó„ÅÑÊÑüÊÉÖ„ÄÇ',
            visual: 'radial-gradient(circle at 30% 30%, #FF69B4 0%, #FFB6C1 30%, #FFF0F5 100%)'
          },
          {
            id: 'struggle',
            title: 'Ë©¶Á∑¥',
            subtitle: 'Storm',
            color: '#ECEFF1',
            accent: '#607D8B',
            emoji: 'üåä',
            poem: 'Âµê„ÇíË∂ä„Åà„Å¶',
            description: 'ÊöóÈóò„ÅÆ‰∏≠„ÅßËá™ÂàÜ„Å®Âêë„ÅçÂêà„ÅÜ„ÄÇÂÇ∑„Å§„Åç„Å™„Åå„Çâ„ÇÇ„ÄÅÂº∑„Åï„ÇíË¶ã„Å§„Åë„ÇãÊôÇ„ÄÇ',
            visual: 'linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)'
          },
          {
            id: 'wisdom',
            title: 'ÊàêÁÜü',
            subtitle: 'Harvest',
            color: '#FFF8E1',
            accent: '#FF9800',
            emoji: 'üçÇ',
            poem: 'ÂÆü„Çä„ÅÆÁßã',
            description: 'ÁµåÈ®ì„ÅåÁü•ÊÅµ„Å®„Å™„Çä„ÄÅ‰∫∫Áîü„ÅÆÊ∑±„Åø„ÇíÁêÜËß£„Åô„Çã„ÄÇÁ©è„ÇÑ„Åã„Å™Âº∑„Åï„Å®ÊÖà„Åó„Åø„ÄÇ',
            visual: 'linear-gradient(135deg, #F4A460 0%, #DAA520 50%, #8B4513 100%)'
          },
          {
            id: 'legacy',
            title: 'Á∂ôÊâø',
            subtitle: 'Legacy',
            color: '#F3E5F5',
            accent: '#9C27B0',
            emoji: '‚ú®',
            poem: 'Êòü„Å´„Å™„Çã',
            description: 'Ëá™ÂàÜ„ÅåÊÆã„Åô„ÇÇ„ÅÆ„ÅØ‰Ωï„Åã„ÄÇÊ¨°„ÅÆ‰∏ñ‰ª£„Å∏„Å®Áπã„Åå„Çã„ÄÅÊ∞∏ÈÅ†„ÅÆÁâ©Ë™û„ÄÇ',
            visual: 'radial-gradient(ellipse at 50% 0%, #2c003e 0%, #0d0015 50%, #000 100%)'
          }
        ];

        function LifeJourney() {
          const [activeTab, setActiveTab] = useState(0);
          const [isTransitioning, setIsTransitioning] = useState(false);

          const handleTabChange = (index) => {
            if (index === activeTab || isTransitioning) return;
            setIsTransitioning(true);
            setTimeout(() => {
              setActiveTab(index);
              setIsTransitioning(false);
            }, 300);
          };

          const current = chapters[activeTab];
          const isDark = activeTab === 4 || activeTab === 6;

          return (
            <div style={{
              minHeight: '100vh',
              fontFamily: '"Noto Serif JP", Georgia, serif',
              background: current.visual,
              transition: 'background 0.8s ease-in-out',
              display: 'flex',
              flexDirection: 'column',
              overflow: 'hidden'
            }}>
              <style>{\`
                @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;500;700&family=Zen+Kaku+Gothic+New:wght@300;400&display=swap');
                
                @keyframes float {
                  0%, 100% { transform: translateY(0) rotate(0deg); }
                  50% { transform: translateY(-20px) rotate(5deg); }
                }
                
                @keyframes pulse {
                  0%, 100% { opacity: 0.6; transform: scale(1); }
                  50% { opacity: 1; transform: scale(1.05); }
                }
                
                @keyframes slideUp {
                  from { opacity: 0; transform: translateY(40px); }
                  to { opacity: 1; transform: translateY(0); }
                }
                
                @keyframes starTwinkle {
                  0%, 100% { opacity: 0.3; }
                  50% { opacity: 1; }
                }
                
                .tab-button {
                  position: relative;
                  padding: 12px 8px;
                  background: transparent;
                  border: none;
                  cursor: pointer;
                  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  gap: 6px;
                  opacity: 0.6;
                }
                
                .tab-button:hover {
                  opacity: 1;
                  transform: translateY(-4px);
                }
                
                .tab-button.active {
                  opacity: 1;
                }
                
                .tab-button.active::after {
                  content: '';
                  position: absolute;
                  bottom: 0;
                  left: 50%;
                  transform: translateX(-50%);
                  width: 30px;
                  height: 3px;
                  background: currentColor;
                  border-radius: 2px;
                }
                
                .content-area {
                  flex: 1;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  justify-content: center;
                  padding: 40px 20px;
                  position: relative;
                }
                
                .floating-emoji {
                  position: absolute;
                  font-size: 80px;
                  animation: float 6s ease-in-out infinite;
                  opacity: 0.3;
                  filter: blur(2px);
                  z-index: 0;
                }
                
                .main-content {
                  position: relative;
                  z-index: 1;
                  text-align: center;
                  max-width: 600px;
                  animation: slideUp 0.6s ease-out;
                }
                
                .chapter-emoji {
                  font-size: 100px;
                  animation: pulse 3s ease-in-out infinite;
                  margin-bottom: 20px;
                }
                
                .chapter-title {
                  font-size: 4rem;
                  font-weight: 700;
                  letter-spacing: 0.3em;
                  margin: 0;
                  text-shadow: 0 4px 30px rgba(0,0,0,0.1);
                }
                
                .chapter-subtitle {
                  font-family: 'Zen Kaku Gothic New', sans-serif;
                  font-size: 1rem;
                  letter-spacing: 0.5em;
                  text-transform: uppercase;
                  opacity: 0.7;
                  margin-top: 8px;
                }
                
                .chapter-poem {
                  font-size: 1.5rem;
                  font-weight: 300;
                  margin: 30px 0;
                  font-style: italic;
                  opacity: 0.9;
                }
                
                .chapter-description {
                  font-family: 'Zen Kaku Gothic New', sans-serif;
                  font-size: 1.1rem;
                  line-height: 2;
                  opacity: 0.85;
                  max-width: 500px;
                  margin: 0 auto;
                }
                
                .progress-bar {
                  position: absolute;
                  bottom: 0;
                  left: 0;
                  right: 0;
                  height: 4px;
                  background: rgba(255,255,255,0.2);
                }
                
                .progress-fill {
                  height: 100%;
                  transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
                }

                .star {
                  position: absolute;
                  width: 4px;
                  height: 4px;
                  background: white;
                  border-radius: 50%;
                  animation: starTwinkle 2s ease-in-out infinite;
                }
              \`}</style>

              {isDark && Array.from({ length: 30 }).map((_, i) => (
                <div
                  key={i}
                  className="star"
                  style={{
                    left: \`\${Math.random() * 100}%\`,
                    top: \`\${Math.random() * 60}%\`,
                    animationDelay: \`\${Math.random() * 2}s\`,
                    opacity: Math.random() * 0.5 + 0.3
                  }}
                />
              ))}

              <nav style={{
                display: 'flex',
                justifyContent: 'center',
                gap: '8px',
                padding: '30px 20px 20px',
                flexWrap: 'wrap',
                color: isDark ? '#fff' : '#333'
              }}>
                {chapters.map((chapter, index) => (
                  <button
                    key={chapter.id}
                    className={\`tab-button \${activeTab === index ? 'active' : ''}\`}
                    onClick={() => handleTabChange(index)}
                    style={{ color: 'inherit' }}
                  >
                    <span style={{ fontSize: '24px' }}>{chapter.emoji}</span>
                    <span style={{
                      fontSize: '12px',
                      fontFamily: '"Zen Kaku Gothic New", sans-serif',
                      letterSpacing: '0.1em'
                    }}>
                      {chapter.title}
                    </span>
                  </button>
                ))}
              </nav>

              <main className="content-area" style={{
                color: isDark ? '#fff' : '#333',
                opacity: isTransitioning ? 0 : 1,
                transition: 'opacity 0.3s ease'
              }}>
                <span className="floating-emoji" style={{ top: '10%', left: '5%', animationDelay: '0s' }}>
                  {current.emoji}
                </span>
                <span className="floating-emoji" style={{ top: '60%', right: '10%', animationDelay: '2s' }}>
                  {current.emoji}
                </span>
                <span className="floating-emoji" style={{ bottom: '20%', left: '15%', animationDelay: '4s' }}>
                  {current.emoji}
                </span>

                <div className="main-content" key={activeTab}>
                  <div className="chapter-emoji">{current.emoji}</div>
                  <h1 className="chapter-title">{current.title}</h1>
                  <p className="chapter-subtitle">{current.subtitle}</p>
                  <p className="chapter-poem">„Äå{current.poem}„Äç</p>
                  <p className="chapter-description">{current.description}</p>
                </div>
              </main>

              <div className="progress-bar">
                <div 
                  className="progress-fill"
                  style={{
                    width: \`\${((activeTab + 1) / chapters.length) * 100}%\`,
                    background: current.accent
                  }}
                />
              </div>

              <div style={{
                position: 'absolute',
                bottom: '20px',
                right: '20px',
                fontFamily: '"Zen Kaku Gothic New", sans-serif',
                fontSize: '14px',
                opacity: 0.6,
                color: isDark ? '#fff' : '#333'
              }}>
                {String(activeTab + 1).padStart(2, '0')} / {String(chapters.length).padStart(2, '0')}
              </div>
            </div>
          );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<LifeJourney />);
    <\/script>
</body>
</html>`;

        // Launch game function
        function launchGame(type) {
            const container = document.getElementById(type + 'Container');
            const frame = document.getElementById(type + 'Frame');
            
            frame.srcdoc = gameContent[type];
            container.classList.add('active');
        }

        // Close game function
        function closeGame(type) {
            const container = document.getElementById(type + 'Container');
            const frame = document.getElementById(type + 'Frame');
            
            container.classList.remove('active');
            setTimeout(() => {
                frame.srcdoc = '';
            }, 300);
        }
    </script>
</body>
</html>
